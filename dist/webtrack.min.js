"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).WebTrack=t()}(function(){return function a(o,s,l){function h(e,t){if(!s[e]){if(!o[e]){var n="function"==typeof require&&require;if(!t&&n)return n(e,!0);if(u)return u(e,!0);var i=new Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}var r=s[e]={exports:{}};o[e][0].call(r.exports,function(t){return h(o[e][1][t]||t)},r,r.exports,a,o,s,l)}return s[e].exports}for(var u="function"==typeof require&&require,t=0;t<l.length;t++)h(l[t]);return h}({1:[function(t,e,n){function M(t){return function(t){if(Array.isArray(t))return i(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function o(e,t){var n,i=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)),i}function T(r){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach(function(t){var e,n,i;e=r,i=a[n=t],n in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach(function(t){Object.defineProperty(r,t,Object.getOwnPropertyDescriptor(a,t))})}return r}function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function W(t,e){var n=e.get(t);if(!n)throw new TypeError("attempted to get private field on non-instance");return n.get?n.get.call(t):n.value}function A(t,e,n){var i=e.get(t);if(!i)throw new TypeError("attempted to set private field on non-instance");if(i.set)i.set.call(t,n);else{if(!i.writable)throw new TypeError("attempted to set read only private field");i.value=n}return n}var a=new WeakMap,s=new WeakMap,O=new WeakMap,S=new WeakMap,x=new WeakMap,F=new WeakMap,D=new WeakMap,j=new WeakMap,P=new WeakMap,q=new WeakMap,N=new WeakMap,V=new WeakMap,l=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),a.set(this,{writable:!0,value:"webtrack-bin"}),s.set(this,{writable:!0,value:"0.0.1"}),O.set(this,{writable:!0,value:[]}),S.set(this,{writable:!0,value:[]}),x.set(this,{writable:!0,value:{}}),F.set(this,{writable:!0,value:null}),D.set(this,{writable:!0,value:0}),j.set(this,{writable:!0,value:0}),P.set(this,{writable:!0,value:0}),q.set(this,{writable:!0,value:0}),N.set(this,{writable:!0,value:0}),V.set(this,{writable:!0,value:void 0})}var e,n,i;return e=t,(n=[{key:"loadGPX",value:function(t){var l=this;A(this,O,[]),A(this,S,[]),A(this,j,0),A(this,P,0);var e=(new window.DOMParser).parseFromString(t.trim(),"text/xml"),n=[].slice.call(e.querySelectorAll("trk")),h={},u=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,f=0,w=0;return n.forEach(function(t){var r=[],e=[].slice.call(t.querySelectorAll("trkpt")),a={},o=!0,s=null;if(e.forEach(function(t){var e={};e.lat=parseFloat(t.getAttribute("lat")),e.lon=parseFloat(t.getAttribute("lon")),e.ele=parseFloat(l._getElementValue(t,"ele"))||null,0===Object.keys(h).length&&h.constructor===Object?e.cumulDist=0:e.cumulDist=h.cumulDist+l.distanceBetween(h,e),h=T({},e),r.push(e);var n,i=l.gpsToWeb(e.lon,e.lat);o?(null===e.ele?(a.withEle=!1,a.points=[[].concat(M(i),[e.cumulDist])]):(a.withEle=!0,a.points=[[].concat(M(i),[e.cumulDist,e.ele])]),o=!1):null===e.ele?a.withEle?(A(l,j,W(l,j)+a.points.length),W(l,O).push(a),(a={withEle:!1}).points=[[].concat(M(i),[e.cumulDist])]):a.points.push([].concat(M(i),[e.cumulDist])):a.withEle?a.points.push([].concat(M(i),[e.cumulDist,e.ele])):(A(l,P,W(l,P)+a.points.length),W(l,O).push(a),(a={withEle:!0}).points=[[].concat(M(i),[e.cumulDist,e.ele])]),null!==e.ele&&(null!==s&&((n=e.ele-s)<0?w-=n:0<n&&(f+=n)),u>e.ele&&(u=e.ele),c<e.ele&&(c=e.ele),s=e.ele)}),a&&(a.withEle?A(l,j,W(l,j)+a.points.length):A(l,P,W(l,P)+a.points.length),W(l,O).push(a)),255<W(l,O).length)throw"Failed to load the GPX string: exceeding 255 segments"}),A(this,x,{length:this.getTrackLength(),min:u,max:c,gain:f,loss:w}),[].slice.call(e.querySelectorAll("wpt")).forEach(function(t){var e=l._getElementValue(t,"time"),n=l.gpsToWeb(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat")));W(l,S).push({name:l._getElementValue(t,"name")||null,sym:l._getElementValue(t,"sym")||null,lon:n[0],lat:n[1],ele:parseFloat(l._getElementValue(t,"ele"))||null,time:null==e?null:new Date(e)})}),A(this,N,W(this,S).length),A(this,D,this._fmtArraySize()+this._trksArraySize()+this._wptsArraySize()),this.createBuffer(),this}},{key:"_getElementValue",value:function(t,e){var n=t.querySelector(e);return null!=n?null!=n.innerHTML?n.innerHTML:n.childNodes[0].data:n}},{key:"distanceBetween",value:function(t,e){var n={};n.lat=t.lat,n.lon=t.lon;var i={};i.lat=e.lat,i.lon=e.lon;var r=Math.PI/180,a=n.lat*r,o=i.lat*r,s=Math.sin((i.lat-n.lat)*r/2),l=Math.sin((i.lon-n.lon)*r/2),h=s*s+Math.cos(a)*Math.cos(o)*l*l;return 6371008*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))}},{key:"_fmtText",value:function(){return"".concat(W(this,a),":").concat(W(this,s),":")}},{key:"_fmtArraySize",value:function(){return this._fmtText().length+3}},{key:"_trksArraySize",value:function(){var t=W(this,O).length,e=0;return 0<t&&(e+=5*t,e+=4,0<W(this,j)&&(e+=12),e+=4*t+6*W(this,P)+8*W(this,j)),e}},{key:"_wptsArraySize",value:function(){var e=0;return W(this,S).forEach(function(t){e+=11+(t.ele?2:0)+(t.sym?t.sym.length:0)+(t.name?t.name.length:0)}),e}},{key:"someTracksWithEle",value:function(){return 0<W(this,j)}},{key:"getBufferSize",value:function(){return W(this,D)}},{key:"_wUint8",value:function(t){var e;W(this,V).setUint8((A(this,q,1+(e=+W(this,q))),e),t)}},{key:"_rUint8",value:function(){var t;return W(this,V).getUint8((A(this,q,1+(t=+W(this,q))),t))}},{key:"_wUint16",value:function(t){W(this,V).setUint16(W(this,q),t,!1),A(this,q,W(this,q)+2)}},{key:"_rUint16",value:function(){var t=W(this,q);return A(this,q,W(this,q)+2),W(this,V).getUint16(t,!1)}},{key:"_wInt16",value:function(t){W(this,V).setInt16(W(this,q),t,!1),A(this,q,W(this,q)+2)}},{key:"_rInt16",value:function(){var t=W(this,q);return A(this,q,W(this,q)+2),W(this,V).getInt16(t,!1)}},{key:"_wUint32",value:function(t){W(this,V).setUint32(W(this,q),t,!1),A(this,q,W(this,q)+4)}},{key:"_rUint32",value:function(){var t=W(this,q);return A(this,q,W(this,q)+4),W(this,V).getUint32(t,!1)}},{key:"_wInt32",value:function(t){W(this,V).setInt32(W(this,q),t,!1),A(this,q,W(this,q)+4)}},{key:"_rInt32",value:function(){var t=W(this,q);return A(this,q,W(this,q)+4),W(this,V).getInt32(t,!1)}},{key:"gpsToWeb",value:function(t,e){var n=Math.PI/180;return[6378137*t*n,6378137*Math.atanh(Math.sin(e*n))]}},{key:"getTrackInfo",value:function(){return T(T({},W(this,x)),{},{trackPoints:{withEle:W(this,j),withoutEle:W(this,P)}})}},{key:"getTrack",value:function(){return W(this,O)}},{key:"getWaypoints",value:function(){return W(this,S)}},{key:"getTrackLength",value:function(){var t=W(this,O)[W(this,O).length-1].points;return t[t.length-1][2]}},{key:"createBuffer",value:function(){var a=this;if(0==W(this,D))throw"Failed to create the WebTrack buffer: empty buffer";A(this,F,new ArrayBuffer(W(this,D))),A(this,V,new DataView(W(this,F)));var e=new TextEncoder,n={withEle:e.encode("E")[0],withoutEle:e.encode("F")[0],separator:e.encode("\n")[0]},t=e.encode(this._fmtText());A(this,q,0),t.forEach(function(t){a._wUint8(t)});var i=W(this,O).length;if(255<i)throw"Failed to create the WebTrack buffer: too many segments";if(this._wUint8(i),65535<W(this,N))throw"Failed to create the WebTrack buffer: too many waypoints";this._wUint16(W(this,N)),W(this,O).forEach(function(t){var e=t.withEle?n.withEle:n.withoutEle;a._wUint8(e),a._wUint32(t.points.length)}),this._wUint32(Math.round(W(this,x).length)),this.someTracksWithEle()&&(this._wInt16(Math.round(W(this,x).min)),this._wInt16(Math.round(W(this,x).max)),this._wUint32(Math.round(W(this,x).gain)),this._wUint32(Math.round(W(this,x).loss)));var o=0,s=0;if(W(this,O).forEach(function(i){var r=null;i.points.forEach(function(t){if(null===r)a._wInt32(Math.round(t[0])),a._wInt32(Math.round(t[1])),a._wUint16(Math.round(t[2]/10)),s=o=0;else{var e=t[0]-r[0]+o,n=t[1]-r[1]+s;if(32767<e||e<-32768||32767<n||n<-32768)throw"Failed to create the WebTrack buffer: offset out or range";a._wInt16(Math.round(e)),a._wInt16(Math.round(n)),o=e-Math.round(e),s=n-Math.round(n),a._wUint16(Math.round(t[2]/10))}r=t,i.withEle&&a._wInt16(Math.round(t[3]))})}),W(this,S).forEach(function(t){a._wInt32(Math.round(t.lon)),a._wInt32(Math.round(t.lat)),a._wUint8(t.ele?n.withEle:n.withoutEle),t.ele&&a._wInt16(Math.round(t.ele)),t.sym&&e.encode(t.sym).forEach(function(t){a._wUint8(t)}),a._wUint8(n.separator),t.name&&e.encode(t.name).forEach(function(t){a._wUint8(t)}),a._wUint8(n.separator)}),W(this,q)!=W(this,D))throw"Failed to create the WebTrack buffer: final position and buffer size mismatch";return this}},{key:"getBuffer",value:function(){return W(this,F)}},{key:"_formatInfoPass",value:function(){if(!W(this,F))return!1;var t=new TextDecoder,e=new Uint8Array(W(this,F),0,this._fmtText().length);return this._fmtText()==t.decode(e)}},{key:"loadWebTrack",value:function(t){if(!t)throw"Failed to load WebTrack: bad input buffer";A(this,F,t);var e=new Uint8Array(t);if(A(this,D,e.length),!this._formatInfoPass())throw"Failed to load WebTrack: bad file format";var n=new TextEncoder,i=n.encode("E")[0],r=n.encode("F")[0],a=n.encode("\n")[0];A(this,V,new DataView(W(this,F))),A(this,q,this._fmtText().length);var o=this._rUint8();A(this,N,this._rUint16()),A(this,O,new Array(o)),A(this,j,0),A(this,P,0);for(var s,l=0;l<o;l++){var h=this._rUint8(),u=this._rUint32(),c=void 0;switch(h){case i:c=!0,A(this,j,W(this,j)+u);break;case r:c=!1,A(this,P,W(this,P)+u);break;default:throw"Failed to load WebTrack: bad segment type"}W(this,O)[l]={withEle:c,points:new Array(u)}}o?(s=this._rUint32(),this.someTracksWithEle()?A(this,x,{length:s,min:this._rInt16(),max:this._rInt16(),gain:this._rUint32(),loss:this._rUint32()}):A(this,x,{length:s})):A(this,x,{});for(var f=0;f<o;f++)for(var w=W(this,O)[f].points.length,p=W(this,O)[f].withEle,y=null,d=0;d<w;d++)y=null===y?[this._rInt32(),this._rInt32(),10*this._rUint16()]:[this._rInt16()+y[0],this._rInt16()+y[1],10*this._rUint16()],p&&(y=[].concat(M(y),[this._rInt16()])),W(this,O)[f].points[d]=y;var v=new TextDecoder;A(this,S,new Array(W(this,N)));for(var b=0;b<W(this,N);b++){var m={lon:this._rInt32(),lat:this._rInt32()};switch(this._rUint8()){case i:m=T(T({},m),{},{ele:this._rInt16()});break;case r:break;default:throw"Failed to load WebTrack: bad waypoint type"}for(var _=[],g=this._rUint8();g!=a;g=this._rUint8())_.push(g);for(var k=new Uint8Array(_),E=v.decode(k),_=[],U=this._rUint8();U!=a;U=this._rUint8())_.push(U);k=new Uint8Array(_);var I=v.decode(k);W(this,S)[b]=T(T({},m),{},{sym:E,name:I})}return this}}])&&r(e.prototype,n),i&&r(e,i),t}();void 0!==e&&(e.exports=l)},{}]},{},[1])(1)});
//# sourceMappingURL=webtrack.min.js.map
