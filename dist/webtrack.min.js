"use strict";function _typeof2(t){return(_typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t){"object"===("undefined"==typeof exports?"undefined":_typeof2(exports))&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).WebTrack=t()}(function(){return function a(o,s,l){function h(e,t){if(!s[e]){if(!o[e]){var n="function"==typeof require&&require;if(!t&&n)return n(e,!0);if(u)return u(e,!0);var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}var i=s[e]={exports:{}};o[e][0].call(i.exports,function(t){return h(o[e][1][t]||t)},i,i.exports,a,o,s,l)}return s[e].exports}for(var u="function"==typeof require&&require,t=0;t<l.length;t++)h(l[t]);return h}({1:[function(t,e,n){function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function I(t){return function(t){if(Array.isArray(t))return i(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function o(e,t){var n,r=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)),r}function T(i){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach(function(t){var e,n,r;e=i,r=a[n=t],n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(a,t))})}return i}function a(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function S(t,e){var n=e.get(t);if(!n)throw new TypeError("attempted to get private field on non-instance");return n.get?n.get.call(t):n.value}function W(t,e,n){var r=e.get(t);if(!r)throw new TypeError("attempted to set private field on non-instance");if(r.set)r.set.call(t,n);else{if(!r.writable)throw new TypeError("attempted to set read only private field");r.value=n}return n}var s=new WeakMap,l=new WeakMap,A=new WeakMap,O=new WeakMap,x=new WeakMap,F=new WeakMap,j=new WeakMap,D=new WeakMap,P=new WeakMap,q=new WeakMap,N=new WeakMap,V=new WeakMap,h=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),s.set(this,{writable:!0,value:"webtrack-bin"}),l.set(this,{writable:!0,value:"0.1.0"}),A.set(this,{writable:!0,value:[]}),O.set(this,{writable:!0,value:[]}),x.set(this,{writable:!0,value:{}}),F.set(this,{writable:!0,value:null}),j.set(this,{writable:!0,value:0}),D.set(this,{writable:!0,value:0}),P.set(this,{writable:!0,value:0}),q.set(this,{writable:!0,value:0}),N.set(this,{writable:!0,value:0}),V.set(this,{writable:!0,value:void 0})}var e,n,r;return e=t,(n=[{key:"loadGPX",value:function(t){var l=this;W(this,A,[]),W(this,O,[]),W(this,D,0),W(this,P,0);var e=(new window.DOMParser).parseFromString(t.trim(),"text/xml"),n=[].slice.call(e.querySelectorAll("trk")),h={},u=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,f=0,w=0;return n.forEach(function(t){var i=[],e=[].slice.call(t.querySelectorAll("trkpt")),a={},o=!0,s=null;if(e.forEach(function(t){var e={};e.lat=parseFloat(t.getAttribute("lat")),e.lon=parseFloat(t.getAttribute("lon")),e.ele=parseFloat(l._getElementValue(t,"ele"))||null,0===Object.keys(h).length&&h.constructor===Object?e.cumulDist=0:e.cumulDist=h.cumulDist+l.distanceBetween(h,e),h=T({},e),i.push(e);var n,r=l.gpsToWeb(e.lon,e.lat);o?(null===e.ele?(a.withEle=!1,a.points=[[].concat(I(r),[e.cumulDist])]):(a.withEle=!0,a.points=[[].concat(I(r),[e.cumulDist,e.ele])]),o=!1):null===e.ele?a.withEle?(W(l,D,S(l,D)+a.points.length),S(l,A).push(a),(a={withEle:!1}).points=[[].concat(I(r),[e.cumulDist])]):a.points.push([].concat(I(r),[e.cumulDist])):a.withEle?a.points.push([].concat(I(r),[e.cumulDist,e.ele])):(W(l,P,S(l,P)+a.points.length),S(l,A).push(a),(a={withEle:!0}).points=[[].concat(I(r),[e.cumulDist,e.ele])]),null!==e.ele&&(null!==s&&((n=e.ele-s)<0?w-=n:0<n&&(f+=n)),u>e.ele&&(u=e.ele),c<e.ele&&(c=e.ele),s=e.ele)}),a&&(a.withEle?W(l,D,S(l,D)+a.points.length):W(l,P,S(l,P)+a.points.length),S(l,A).push(a)),255<S(l,A).length)throw"Failed to load the GPX string: exceeding 255 segments"}),W(this,x,{length:this.getTrackLength(),min:u,max:c,gain:f,loss:w}),[].slice.call(e.querySelectorAll("wpt")).forEach(function(t){var e=l._getElementValue(t,"time"),n=l.gpsToWeb(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat")));S(l,O).push({name:l._getElementValue(t,"name")||null,sym:l._getElementValue(t,"sym")||null,lon:n[0],lat:n[1],ele:parseFloat(l._getElementValue(t,"ele"))||null,time:null==e?null:new Date(e)})}),W(this,N,S(this,O).length),W(this,j,this._fmtArraySize()+this._trksArraySize()+this._wptsArraySize()),this.createBuffer(),this}},{key:"_getElementValue",value:function(t,e){var n=t.querySelector(e);return null!=n?null!=n.innerHTML?n.innerHTML:n.childNodes[0].data:n}},{key:"distanceBetween",value:function(t,e){var n={};n.lat=t.lat,n.lon=t.lon;var r={};r.lat=e.lat,r.lon=e.lon;var i=Math.PI/180,a=n.lat*i,o=r.lat*i,s=Math.sin((r.lat-n.lat)*i/2),l=Math.sin((r.lon-n.lon)*i/2),h=s*s+Math.cos(a)*Math.cos(o)*l*l;return 6371008*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))}},{key:"_fmtText",value:function(){return"".concat(S(this,s),":").concat(S(this,l),":")}},{key:"_fmtArraySize",value:function(){return this._fmtText().length+3}},{key:"_trksArraySize",value:function(){var t=S(this,A).length,e=0;return 0<t&&(e+=5*t,e+=4,0<S(this,D)&&(e+=12),e+=4*t+6*S(this,P)+8*S(this,D)),e}},{key:"_wptsArraySize",value:function(){var e=0;return S(this,O).forEach(function(t){e+=11+(t.ele?2:0)+(t.sym?t.sym.length:0)+(t.name?t.name.length:0)}),e}},{key:"someTracksWithEle",value:function(){return 0<S(this,D)}},{key:"getBufferSize",value:function(){return S(this,j)}},{key:"_wUint8",value:function(t){var e;S(this,V).setUint8((W(this,q,1+(e=+S(this,q))),e),t)}},{key:"_rUint8",value:function(){var t;return S(this,V).getUint8((W(this,q,1+(t=+S(this,q))),t))}},{key:"_wUint16",value:function(t){S(this,V).setUint16(S(this,q),t,!1),W(this,q,S(this,q)+2)}},{key:"_rUint16",value:function(){var t=S(this,q);return W(this,q,S(this,q)+2),S(this,V).getUint16(t,!1)}},{key:"_wInt16",value:function(t){S(this,V).setInt16(S(this,q),t,!1),W(this,q,S(this,q)+2)}},{key:"_rInt16",value:function(){var t=S(this,q);return W(this,q,S(this,q)+2),S(this,V).getInt16(t,!1)}},{key:"_wUint32",value:function(t){S(this,V).setUint32(S(this,q),t,!1),W(this,q,S(this,q)+4)}},{key:"_rUint32",value:function(){var t=S(this,q);return W(this,q,S(this,q)+4),S(this,V).getUint32(t,!1)}},{key:"_wInt32",value:function(t){S(this,V).setInt32(S(this,q),t,!1),W(this,q,S(this,q)+4)}},{key:"_rInt32",value:function(){var t=S(this,q);return W(this,q,S(this,q)+4),S(this,V).getInt32(t,!1)}},{key:"gpsToWeb",value:function(t,e){var n=Math.PI/180;return[6378137*t*n,6378137*Math.atanh(Math.sin(e*n))]}},{key:"getTrackInfo",value:function(){return T(T({},S(this,x)),{},{trackPoints:{withEle:S(this,D),withoutEle:S(this,P)}})}},{key:"getTrack",value:function(){return S(this,A)}},{key:"getWaypoints",value:function(){return S(this,O)}},{key:"getTrackLength",value:function(){var t=S(this,A)[S(this,A).length-1].points;return t[t.length-1][2]}},{key:"createBuffer",value:function(){var a=this;if(0==S(this,j))throw"Failed to create the WebTrack buffer: empty buffer";W(this,F,new ArrayBuffer(S(this,j))),W(this,V,new DataView(S(this,F)));var e=new TextEncoder,n={withEle:e.encode("E")[0],withoutEle:e.encode("F")[0],separator:e.encode("\n")[0]},t=e.encode(this._fmtText());W(this,q,0),t.forEach(function(t){a._wUint8(t)});var r=S(this,A).length;if(255<r)throw"Failed to create the WebTrack buffer: too many segments";if(this._wUint8(r),65535<S(this,N))throw"Failed to create the WebTrack buffer: too many waypoints";if(this._wUint16(S(this,N)),S(this,A).forEach(function(t){var e=t.withEle?n.withEle:n.withoutEle;a._wUint8(e),a._wUint32(t.points.length)}),this._wUint32(Math.round(S(this,x).length)),this.someTracksWithEle()&&(this._wInt16(Math.round(S(this,x).min)),this._wInt16(Math.round(S(this,x).max)),this._wUint32(Math.round(S(this,x).gain)),this._wUint32(Math.round(S(this,x).loss))),S(this,A).forEach(function(r){var i=null;r.points.forEach(function(t){if(null===i)a._wInt32(Math.round(t[0])),a._wInt32(Math.round(t[1])),a._wUint16(Math.round(t[2]/10));else{var e=Math.round(t[0])-Math.round(i[0]),n=Math.round(t[1])-Math.round(i[1]);if(32767<e||e<-32768||32767<n||n<-32768)throw"Failed to create the WebTrack buffer: offset out or range";a._wInt16(Math.round(e)),a._wInt16(Math.round(n)),a._wUint16(Math.round(t[2]/10))}i=t,r.withEle&&a._wInt16(Math.round(t[3]))})}),S(this,O).forEach(function(t){a._wInt32(Math.round(t.lon)),a._wInt32(Math.round(t.lat)),a._wUint8(t.ele?n.withEle:n.withoutEle),t.ele&&a._wInt16(Math.round(t.ele)),t.sym&&e.encode(t.sym).forEach(function(t){a._wUint8(t)}),a._wUint8(n.separator),t.name&&e.encode(t.name).forEach(function(t){a._wUint8(t)}),a._wUint8(n.separator)}),S(this,q)!=S(this,j))throw"Failed to create the WebTrack buffer: final position and buffer size mismatch";return this}},{key:"getBuffer",value:function(){return S(this,F)}},{key:"_formatInfoPass",value:function(){if(!S(this,F))return!1;var t=new TextDecoder,e=new Uint8Array(S(this,F),0,this._fmtText().length);return this._fmtText()==t.decode(e)}},{key:"loadWebTrack",value:function(t){if(!t)throw"Failed to load WebTrack: bad input buffer";W(this,F,t);var e=new Uint8Array(t);if(W(this,j,e.length),!this._formatInfoPass())throw"Failed to load WebTrack: bad file format";var n=new TextEncoder,r=n.encode("E")[0],i=n.encode("F")[0],a=n.encode("\n")[0];W(this,V,new DataView(S(this,F))),W(this,q,this._fmtText().length);var o=this._rUint8();W(this,N,this._rUint16()),W(this,A,new Array(o)),W(this,D,0),W(this,P,0);for(var s,l=0;l<o;l++){var h=this._rUint8(),u=this._rUint32(),c=void 0;switch(h){case r:c=!0,W(this,D,S(this,D)+u);break;case i:c=!1,W(this,P,S(this,P)+u);break;default:throw"Failed to load WebTrack: bad segment type"}S(this,A)[l]={withEle:c,points:new Array(u)}}o?(s=this._rUint32(),this.someTracksWithEle()?W(this,x,{length:s,min:this._rInt16(),max:this._rInt16(),gain:this._rUint32(),loss:this._rUint32()}):W(this,x,{length:s})):W(this,x,{});for(var f=0;f<o;f++)for(var w=S(this,A)[f].points.length,p=S(this,A)[f].withEle,y=null,d=0;d<w;d++)y=null===y?[this._rInt32(),this._rInt32(),10*this._rUint16()]:[this._rInt16()+y[0],this._rInt16()+y[1],10*this._rUint16()],p&&(y=[].concat(I(y),[this._rInt16()])),S(this,A)[f].points[d]=y;var v=new TextDecoder;W(this,O,new Array(S(this,N)));for(var b=0;b<S(this,N);b++){var m={lon:this._rInt32(),lat:this._rInt32()};switch(this._rUint8()){case r:m=T(T({},m),{},{ele:this._rInt16()});break;case i:break;default:throw"Failed to load WebTrack: bad waypoint type"}for(var _=[],g=this._rUint8();g!=a;g=this._rUint8())_.push(g);for(var k=new Uint8Array(_),E=v.decode(k),_=[],U=this._rUint8();U!=a;U=this._rUint8())_.push(U);k=new Uint8Array(_);var M=v.decode(k);S(this,O)[b]=T(T({},m),{},{sym:E,name:M})}return this}}])&&a(e.prototype,n),r&&a(e,r),t}();"object"===(void 0===e?"undefined":r(e))&&e.exports&&(e.exports=h)},{}]},{},[1])(1)});
//# sourceMappingURL=webtrack.min.js.map
